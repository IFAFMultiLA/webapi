<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Server deployment &#8212; MultiLA Web API  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b76e3c8a" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=039e1c02" />
    <script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Codebook for MultiLA web API data export" href="codebook.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="server-deployment">
<span id="deployment"></span><h1>Server deployment<a class="headerlink" href="#server-deployment" title="Link to this heading">¶</a></h1>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>Docker with Docker Compose v2 (recommended: run Docker in <em>rootless</em> mode)</p></li>
<li><p>an HTTP server such as Apache or nginx used as proxy</p></li>
<li><p>a valid SSL certificate – <strong>only run this service via HTTPS in production!</strong></p></li>
</ul>
</section>
<section id="initial-deployment">
<h2>Initial deployment<a class="headerlink" href="#initial-deployment" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>Create a Docker Compose configuration like the following as <code class="docutils literal notranslate"><span class="pre">docker/compose_prod.yml</span></code>:</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2&#39;</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># # optional: DB admin web interface accessible on local port 8081</span>
<span class="w">  </span><span class="c1"># adminer:</span>
<span class="w">  </span><span class="c1">#  image: adminer</span>
<span class="w">  </span><span class="c1">#  ports:</span>
<span class="w">  </span><span class="c1">#    - 127.0.0.1:8081:8080</span>
<span class="w">  </span><span class="c1">#  restart: always</span>

<span class="w">  </span><span class="nt">db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;../data/db:/var/lib/postgresql/data&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;../data/backups:/data_backup&#39;</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;POSTGRES_USER=admin&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;POSTGRES_PASSWORD=&lt;CHANGE_THIS&gt;&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;POSTGRES_DB=multila&#39;</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>

<span class="w">  </span><span class="nt">web</span><span class="p">:</span>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">..</span>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./docker/Dockerfile_prod</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python -m uvicorn --host 0.0.0.0 --port 8000 multila.asgi:application</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;../src:/code&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;../data/export:/data_export&#39;</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;8000:8000&quot;</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;POSTGRES_USER=admin&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;POSTGRES_PASSWORD=&lt;CHANGE_THIS&gt;&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;POSTGRES_DB=multila&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;DJANGO_SETTINGS_MODULE=multila.settings_prod&#39;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;SECRET_KEY=&lt;CHANGE_THIS&gt;&#39;</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
</pre></div>
</div>
<ol class="arabic" start="2">
<li><p>Make sure the correct server and directory is entered in <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> under <code class="docutils literal notranslate"><span class="pre">SERVER</span></code> and <code class="docutils literal notranslate"><span class="pre">APPDIR</span></code>. Then run:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">collectstatic</span></code> to copy all static files to the <code class="docutils literal notranslate"><span class="pre">static_files</span></code> directory</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">sync</span></code> to upload all files to the server</p></li>
</ul>
</div></blockquote>
</li>
<li><p>On the server, do the following:</p>
<blockquote>
<div><ul class="simple">
<li><p>run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">copy_static</span></code> to copy the static files to the directory <code class="docutils literal notranslate"><span class="pre">/var/www/api_static_files/</span></code> (you must have
the permissions to do so)</p></li>
<li><p>run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">build</span></code> to build the web application</p></li>
<li><p>run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">create</span></code> to create the docker containers</p></li>
<li><p>run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">up</span></code> to launch the containers</p></li>
<li><p>run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">migrate</span></code> to initialize the DB</p></li>
<li><p>run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">superuser</span></code> to create a backend admin user – <strong>use a secure password</strong></p></li>
<li><p>run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">check</span></code> to check the deployment</p></li>
<li><p>run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code> to run the tests in the deployment environment</p></li>
<li><p>you may run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">logs</span></code> and/or <code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">http://0.0.0.0:8000/</span></code> to check if the web server is running</p></li>
</ul>
</div></blockquote>
</li>
<li><p>On the server, create an HTTP proxy to forward HTTP requests to the server to the docker container running the web
application. For example, a configuration for the Apache webserver that forwards all requests to
<code class="docutils literal notranslate"><span class="pre">https://&lt;HOST&gt;/api/</span></code> would use the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># setup static files (and prevent them to be passed through the proxy)
ProxyPass /api_static_files !
Alias /api_static_files /var/www/api_static_files

# setup proxy for API
ProxyPass /api/ http://0.0.0.0:8000/
ProxyPassReverse /api/ http://0.0.0.0:8000/
</pre></div>
</div>
</li>
</ol>
<p>All requests to <code class="docutils literal notranslate"><span class="pre">https://&lt;SERVER&gt;/api/</span></code> should then be forwarded to the web application.</p>
</section>
<section id="publishing-updates">
<h2>Publishing updates<a class="headerlink" href="#publishing-updates" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>locally, run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">testsync</span></code> and <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">sync</span></code> to publish updated files to the server</p></li>
<li><p>on the server, optional run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">migrate</span></code> to update the database and run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">restart_web</span></code> to restart the web
application (there is a shortcut <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">server_restart_web</span></code> that you can run <em>locally</em> in order to restart the web
application on the server)</p></li>
<li><p>if there are changes in the static files, you should run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">collectstatic</span></code> before <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">sync</span></code> and then run
<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">copy_static</span></code> on the server</p></li>
<li><p>if there are changes in the dependencies, you need to rebuild the container as decribed above under
<em>Initial deployment</em>, point (3)</p></li>
</ul>
</section>
<section id="optional-db-administration-interface">
<h2>Optional DB administration interface<a class="headerlink" href="#optional-db-administration-interface" title="Link to this heading">¶</a></h2>
<p>If you have enabled the <code class="docutils literal notranslate"><span class="pre">adminer</span></code> service in the docker compose file above, a small DB administration web interface
is running on port 8081 on the server. For security reasons, it is only accessible from localhost, i.e. you need to set
up an SSH tunnel to make it available remotely from your machine. You can do so on your machine by running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="o">-</span><span class="n">N</span> <span class="o">-</span><span class="n">L</span> <span class="mi">8081</span><span class="p">:</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8081</span> <span class="o">&lt;</span><span class="n">USER</span><span class="o">&gt;@&lt;</span><span class="n">SERVER</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>, where <code class="docutils literal notranslate"><span class="pre">&lt;USER&gt;&#64;&lt;SERVER&gt;</span></code> are the login name and the host name of the server, where docker containers are running.
A shortcut is available in the Makefile as <code class="docutils literal notranslate"><span class="pre">adminer_tunnel</span></code>. You can then go to <code class="docutils literal notranslate"><span class="pre">http://localhost:8081/</span></code> in your
browser and login to the Postgres server (not MySQL!) using the <code class="docutils literal notranslate"><span class="pre">POSTGRES_USER</span></code> and <code class="docutils literal notranslate"><span class="pre">POSTGRES_PASSWORD</span></code> listed in
the environment variabless of the docker compose file.</p>
</section>
<section id="db-backups">
<h2>DB backups<a class="headerlink" href="#db-backups" title="Link to this heading">¶</a></h2>
<p>You can use <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">dbbackup</span></code> on the server to generate a PostgreSQL database dump with the current timestamp under
<code class="docutils literal notranslate"><span class="pre">data/backups/</span></code>. It’s advisable to run this command regularly, e.g. via a cronjob, and then copy the database dumps
to a backup destination e.g. via <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">download_dbbackup</span></code>.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">MultiLA Web API</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">MultiLA Web API and administration backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="components.html">Software components</a></li>
<li class="toctree-l1"><a class="reference internal" href="clientserver.html">Client-server communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="devsetup.html">Local development setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="codebook.html">Codebook for MultiLA web API data export</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Server deployment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="#initial-deployment">Initial deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#publishing-updates">Publishing updates</a></li>
<li class="toctree-l2"><a class="reference internal" href="#optional-db-administration-interface">Optional DB administration interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="#db-backups">DB backups</a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="codebook.html" title="previous chapter">Codebook for MultiLA web API data export</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, Markus Konrad.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="_sources/deployment.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>