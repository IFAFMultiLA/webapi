{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block bodyclass %}{{ block.super }} app-{{ app_label }}{% endblock %}

{% block extrahead %}

{{ block.super }}

<script src="{% static 'admin/js/vendor/jquery/jquery.min.js' %}"></script>
<script src="{% static 'admin/js/jquery.init.js' %}"></script>

<script>
    if (!$) {
        $ = django.jQuery;
    }

    $(document).ready(function () {
        function pollFiles() {
            let t = $('#filelist tbody');

            fetch("{% url 'multila_admin:dataexport_filelist' %}")
                .then(response => response.json())
                .then(function (files) {
                    let allReady = true;
                    files.forEach(function (fileStatus) {
                        const f = fileStatus[0];
                        const status = fileStatus[1] ? "ready" : "generating...";
                        allReady = allReady && fileStatus[1];

                        let tRow = t.find("tr[data-key='" + f + "']");

                        if (tRow.length > 0) {
                            tRow.find("td").eq(1).text(status);
                        } else {
                            t.append(
                                "<tr data-key='" + f + "'><td>" + f + "</td><td>" + status + "</td><td></td></tr>"
                            );
                        }
                    });

                    if (allReady && pollingIntervalHandle !== null) {
                        clearInterval(pollingIntervalHandle);
                        pollingIntervalHandle = null;
                    }
                });
        }

        let pollingIntervalHandle = setInterval(pollFiles, 250);
    });
</script>
{% endblock %}

{% if not is_popup %}
{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% translate 'Home' %}</a>
&rsaquo;
Data view
</div>
{% endblock %}
{% endif %}

{% block coltype %}{% endblock %}

{% block content %}

<form action="{% url 'multila_admin:dataexport' %}" method="post">
    {% csrf_token %}

    {{ configform }}

    <input type="submit" value="Create data export">
</form>


<table style="width:100%;margin-top:2em" id="filelist">
    <thead>
        <tr>
            <td>File</td>
            <td>Status</td>
            <td>Action</td>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>


{% endblock %}